# OS

## 一、操作系统

### （1）操作系统的概念

1. 裸机（纯硬件）->操作系统->应用程序（软件）->用户
2. 操作系统： 是指控制和管理整个计算机系统的硬件和软件资源，并合理的组织调度计算机的工作和资源的分配，以提供给用户和其他软件方便的接口和环境，他是计算机系统中最基本的系统软件。<img src="../assets/OS_b_images/截屏2022-10-15 下午3.14.49.png" alt="截屏2022-10-15 下午3.14.49" style="zoom:25%;" />
3. 进程：一个程序的执行过程，执行前需要将该程序放到内存中，才能被CPU处理。
4.  <img src="../assets/OS_b_images/./截屏2022-09-08 上午9.51.40.png" alt="截屏2022-09-08 上午9.51.40" style="zoom:25%;" />

### （2）操作系统的功能和目标

1. 作为用户和计算机硬件之间的接口
2. 用户接口
   1. 命令接口（允许用户直接使用）
      1. 联机命令接口（交互式命令接口）：用户说一句系统做一句
      2. 脱机命令接口（批处理命令接口）：用户对操作系统说一堆，操作系统做一堆
   2. 程序接口（用户通过程序间接调用）：由一组系统调用组成（大多数情况下程序接口=系统调用/广义命令）
3. GUI：图形用户界面
4.  <img src="../assets/OS_b_images/./截屏2022-09-08 上午10.11.36.png" alt="/./截屏2022-09-08 上午10.11.36.png" style="zoom:25%;" />
5. 操作系统是最接近硬件的层次

### （3）操作系统的特性

1. 操作系统的特征：并发、共享、虚拟、异步

2. 并发：指两个或多个事件在同一时间间隔内发生，这些事件宏观上是同时发生的，但是微观上是交替发生的。

   并行——两个或多个事件在同一时刻同时发生（宏观和微观上都是同时的）。

   1. 操作系统的并发性指操作系统中同时存在着多个运行着的程序。
   2. 

3. 共享：资源共享，指系统中的资源可供内存中多个并发执行的进程共同使用。

   1. 资源共享方式
      1. 互斥共享（独占使用）：系统中的某些资源，虽然可以提供给多个进程使用，但一个时间段内只允许一个进程访问该资源。
      2. 同时共享（并发分享）：系统中的某些资源，可以提供给多个进程使用，一个时间段内可允许多个进程访问该资源。**（所谓的同时往往是宏观上的，在微观上这些进程可能是交替的对该资源进行访问的——分时共享）**
   1. 资源分配方式
      1. **静态**分配方式，运行程序进入内存前已经将所有的内存完成分配，好处是不会死锁，坏处是效率低，使用效率低。
      2. **动态**分配方式，随用随分配，可能导致死锁。
      3. **资源抢占**方式，如果你在使用，我的优先级高，我可以抢过来使用，但是涉及到保存状态的问题，被抢夺资源的进程需要回滚执行。

4. 虚拟：将物理上的实体变成若干个逻辑上的对应物，物理实体是实际存在的，而逻辑上的对应物是用户感受到的。（虚拟技术中的“空分复用技术”、“时分复用技术”）——虚拟性依赖于并发性。

5. 异步：在多道程序的环境下，允许多个程序并发执行，但由于资源有限，进程的执行不是一贯到底的，而是走走停停，以不可预知的速度向前推进。

6. 操作系统的三层抽象：

   1. 进程->程序的抽象
   2. 文件系统->磁盘的抽象
   3. 虚拟内存->主存的抽象


### （4）操作系统的发展和分类

1. 手工操作阶段：计算机刚发明的阶段，操作系统未被发明
   1. 主要缺点：用户独占全机，**人机速度矛盾**导致资源利用率极低。
   
2. 批处理阶段
   1. 单道批处理阶段：引入脱机输入输出技术（基于磁带），并监督程序负责控制作业的输入输出。
      1. 优点：**缓解了一定程度的人机速度矛盾**，资源利用率有所提升。
      2. 缺点：内存中仅能运行一道程序，只有该程序运行结束以后才能调入下一道程序。CPU有大量时间是在空闲等待I/O完成，**资源利用率依旧很低**。
   2. 多道批处理阶段：每次往内存中输入多道程序，操作系统正式诞生，并引入了中断技术，由操作系统负责管理这些程序的运行，各个程序并发执行。
      1. 优点：**多道程序并发执行**，共享计算机资源，**资源利用率大幅提升**，CPU和其他资源保持忙碌状态，系统吞吐量大。
      2. 缺点：用户响应时间长，**没有人机交互功能**（用户提交自己的操作以后就只能等待计算机完成，中间不能控制自己的操作执行）。
      3. 多道批处理技术将计算机、I/O设备等分离，各个设备同一时间可以处理不同的程序的作业。<img src="../assets/OS_b_images/./截屏2022-09-08 下午2.37.03.png" alt="/./截屏2022-09-08 下午2.37.03.png" style="zoom:25%;" />
   
3. 分时操作系统：计算机以时间片为单位轮流为各个用户/作业服务，各个用户可以通过终端与计算机交互。
   
   1. 核心：交互控制，划分CPU的时间。
   2. 优点：用户请求可以被及时响应，**解决了人机交互问题**，允许多个用户同时使用一台计算机，并且用户对计算机的操作相互独立，感受不到人的存在。
   3. 缺点：**不能优先处理一些紧急任务**，操作系统对各个用户/作业的优先级相同，循环地为每个处理，不区分任务的紧急性。
   
4. 实时操作系统：**主要特点是及时性和可靠性**

   1. 即支持分时交互，又有大量进程处理突发任务。
   2. 优点：**能够优先响应一些紧急任务**，某些紧急任务不需要时间片排队。
   3.  <img src="../assets/OS_b_images/./截屏2022-09-08 下午2.40.34.png" alt="/./截屏2022-09-08 下午2.40.34.png" style="zoom:25%;" />

5. 其他几种操作系统：<img src="../assets/OS_b_images/./截屏2022-09-08 下午2.41.03.png" alt="/./截屏2022-09-08 下午2.41.03.png" style="zoom:25%;" />

6. 只有一个操作系统同时具备批处理、分时和实时处理的两种以上才被称为*通用操作系统*。

7. 操作系统的功能

   1. 处理器管理：对处理器的管理和调度最终归结为对进程和线程的管理和调度，最大限度提高处理器利用率。
   2. 存储管理：管理内存资源，提供存储空间利用率。
   3. 设备管理：管理各种外部设备，完成用户提出的 I/O 请求;加快数据传输速度，发挥设备的并行性，提高设备的利用率;提供设备驱动程序和中断处理程序,为用户隐蔽硬件操作细节，提供简单的设备使用方法
   4. 文件管理：针对信息资源的管理。
   5. 联网与通信管理：
      1. 网络资源管理
      2. 数据通信管理
      3. 应用服务
      4. 网络管理

8. 操作系统实现的层次结构

   1.  <img src="../assets/OS_b_images/./8.png" alt="8" style="zoom:33%;" />

   2.  <img src="../assets/OS_b_images/./9.png" alt="9" style="zoom:33%;" />

      


### （5）OS的运行机制和体系结构

1. 运行机制：两种指令、两种处理器状态、两种程序
   1. 两种指令
      1. 特权指令（需要核心态）：只有操作系统本身可以使用的指令，在内核态才能调用的命令，不仅仅影响运行程序本身，还会干扰其他程序及操作系统，比如修改机器状态、修改寄存器值等。
      
         如果应用程序执行特权指令则会导致非法执行而产生保护中断，进而转向操作系统的“用户非法执行特权指令”的异常处理程序处理。
      
      2. 非特权指令：所有的用户程序都能够使用的指令，在用户态和内核态都可以调用的命令，在管态和目态下都可以工作。
      
   2. 两种处理器状态
      1. 核心态——管态
      2. 用户态——目态
      
   3. 两种程序
      1. 内核程序（只能在核心态下执行）：系统的管理者，既可以执行特权指令，也可以执行非，运行在核心态。
      2. 应用程序：为保障系统能安全运行，普通应用程序只能执行非特权指令，运行在用户态。
      
   4. 操作系统中的哪些功能需要内核程序执行？->内核
   
   5. 内核 <img src="../assets/OS_b_images/./截屏2022-09-08 下午4.13.40.png" alt="/./截屏2022-09-08 下午4.13.40.png" style="zoom:25%;" />
      1. 内核是计算机上配置的底层如那件，是操作系统最基本、最核心的部分。**实现操作系统内核功能的程序就是内核程序**。
      2.  功能：<img src="../assets/OS_b_images/./截屏2022-09-08 下午4.15.31.png" alt="/./截屏2022-09-08 下午4.15.31.png" style="zoom:25%;" />
         1. 中断处理
         2. 时钟管理
         3. 短程调度
         4. 原语管理
      3. 内核的属性
         1. 内核是由中断驱动的
         2. 内核是不可抢占的
         3. 内核可以在屏蔽中断状态下进行
         4. 内核可以使用特权指令
   
2. 操作系统的体系结构：大内核和微内核
   1. 操作系统的体系结构经典的分法就是将操作系统分成大内核和微内核。
   2. 大内核（单内核）：将操作系统的主要功能模块都作为系统内核，运行在核心态。广泛使用，如windows（自称采用混合式）、Unix/Linux等
      1. 优点：高性能
      2. 缺点：内核代码庞大，结构混乱，难以维护
   3. 微内核：只把最基本的功能保留在内核，强调结构性部件与功能性部件的分离。
      1. 优点：内核功能少，结构清晰、方便维护
      2. 缺点：需要频繁的在核心态和用户态之间切换，带来性能损耗。
   4. 混合内核：微内核和单内核的折中，较多组件在内核态运行以获得更快地执行速度。
   5. 外内核：尽可能减少内核的软件抽象化和传统微内核的消息传递机制，使得开发者专注于硬件的抽象化；部分嵌入式系统使用。
   4. 类比：操作系统的体系结构问题与企业的管理问题很相似。
      内核就是企业的管理层，负责一些重要的工作。只有管理层才能执行特权指令，普通员工只能执行非特权指令。用户态、核心态之间的切换相当于普通员工和管理层之间的工作交接
      大内核：企业初创时体量不大，管理层的人会负责大部分的事情。优点是效率高；缺点是组织
      结构混乱，难以维护。
      微内核：随着企业体量越来越大，管理层只负责最核心的一些工作。优点是组织结构清晰，方
      便维护；缺点是效率低

### （6）中断和异常

1. 中断机制的诞生
   1. 早期计算机只能串行执行，人们发明操作系统引入中断机制，实现了多道程序并发执行。
   2. 本质：发生中断就意味着需要操作系统介入，开展管理工作。
   
2. 中断的概念和作用
   1. 过程：
      1. CPU收到计时部件发出的**中断信号**，切换为核心态该进行处理。
      2. 操作系统内核对中断信号进行处理。
      3. 进程1时间片已用完，换进程2执行。
      4. 进程2发出系统调用（内中断信号），请求输出，CPU切换为核心态，对中断进行处理。
      5. 同2。
      6. OS要求I/O设备工作，进程2中断，进程3运行。
      7. 当I/O完成后，发送中断信号......
      8. 进程2I/O操作完成，恢复进程2的操作
   2. 特点<img src="../assets/OS_b_images/./截屏2022-09-08 下午4.50.11.png" alt="/./截屏2022-09-08 下午4.50.11.png" style="zoom:25%;" />
   
3. 中断的分类
   
   1. 广义上的中断（=内中断+外中断）：指程序执行过程中，遇到急需处理的事件时，暂时中止 CPU 上现行程序的运行，转去执行相应的事件处理程序，待处理完成后再返回原程序被中断处或调度其他程序执行的过程。
   2. 内中断（**异常**、例外、陷入）：信号来源是CPU内部，是因为*当前执行的指令引起的*。
      1. 自愿中断——指令中断（如**系统调用**时使用的访管指令导致的访管中断）
      2. 强迫中断：硬件故障、软件/程序性中断（如地址越界、非法操作、页面故障）
      2. **系统异常**指执行陷入指令而触发系统调用引起的中断事件，如请求设备、请求 I/O、创建进程等，与硬件无关（通过系统异常请求服务），*系统异常可以被认为是异常中的一类*
   3. 外中断（**中断**，狭义上的中断）：信号来源是CPU外部，与当前执行的指令无关。
      1. 外设请求
      2. 人工干预
      2. I/O中断、时钟中断、外部信号中断。
   
4. 操作系统是中断驱动的/中断是激活操作系统的唯一方式，硬件系统设置中断激活的硬件机制，配合操作系统的内核程序完成中断驱动方式（中断处理需要借助硬件电路）——操作系统实现的根本基础。

5. 外中断处理过程：<img src="../assets/OS_b_images/./截屏2022-09-08 下午5.42.28.png" alt="/./截屏2022-09-08 下午5.42.28.png" style="zoom:25%;" />

6. 恢复正常操作
   1. 对于某些中断，在处理完成后直接返回刚刚被中断的进程。
   2. 对于其他的一些中断，需要中断当前进程的运行，调整进程队列，启动进程调度，选择下一个执行的进程并恢复其执行。

7. 中断可以嵌套，在中断处理过程中可以再响应其他中断，但是中断的嵌套层数应该有限制，同时中断的嵌套处理改变了中断处理的次序。

8. 中断和异常的区别

   | 中断                                         | 异常                                         |
   | -------------------------------------------- | -------------------------------------------- |
   | CPU 异步                                     | CPU 同步                                     |
   | 内核态、用户态                               | 大部分在用户态，内核态唯一的异常是“缺页异常” |
   | 一般中断处理程序提供的服务不是当前进程需要的 | 是当前的进程需要的                           |
   | 快速处理，不可以被打断                       | 可以被阻塞                                   |
   | 允许嵌套                                     | 大多为一重等                                 |
   | 不可以被异常打断                             | 可以被中断中断                               |

9. 中断处理

   1. 中断源：程序性中断事件

      该中断处理器执行机器指令引起。

      1. 除数为零、操作数溢出等算术异常：简单处理，报告用户；也可以由用户编写中断续元程序处理。
      2. 非法指令、用户态使用特权指令、地址越界、非法存取等指令异常：终止进程。
      3. 终止进程指令：终止进程。
      4. 虚拟地址异常：指令和数据不在内存当中，调整内存后重新执行指令。

   2. 中断源：处理器硬件故障中断事件（硬中断）

      1. 由处理器、内存储器、总线等硬件故障引起，除了极少类的校验错误可以恢复以外，是非常严重的中断。
      2. 处理原则为：保护现场，停止设备，停止 CPU，向操作员报告，等待人工干预。电脑会配置一个小电容保证尽可能较少硬件损伤。

   3. 中断源：自愿性中断事件（访管中断）

      处理器执行陷入指令请求 OS 服务引起；在操作系统中，它一般又被称作**系统调用**，比如请求分配外设、请求 I/O 等等。

      处理流程是：

      1. 程序执行访管指令，并通过适当方式指明系统调用号。
      2. 通过中断机制进入访管中断处理程序，现场信息被保护到**核心栈**，按功能号实现跳转。
      3. 通过系统调用入口地址表找到对应中断服务历程的入口地址。
      4. 执行终端服务例程。

   4. 中断源：I/O 中断事件（狭义中断事件）

      来源于外围设备报告 I/O 状态的中断事件

      1. I/O 完成：调整进程状态，释放等待进程；
      2. I/O 出错：先向设备发命令索取状态字，分析产生故障的确切原因，再执行复执或请求人工干预；
      3. I/O 异常：等待人工干预，如缺纸中断等待人工加纸；
      4. 设备报道或设备结束：表示有设备接入可供使用或设备断开暂停使用。

   5. 中断源：外部中断事件

      由外围设备发出的信号引起的中断事件：

      1. 时钟中断、间隔时钟中断：记时与时间片处理，最常见。
      2. 设备报到与结束中断：调整设备表。
      3. 键盘/鼠标信号中断：根据信号作出相应反应。
      4. 关机/重启动中断：写回文件，停止设备与 CPU。

10. 中断系统：想用和处理中断的系统，包括软/硬件子系统两部分，中断响应有硬件子系统完成，中断处理有软件子系统完成。中断系统是操作系统的基础，中断系统也是软硬件协同的经典例子。

11. 中断的响应：指令执行周期最后增加一个微操作，以响应中断，CPU 在完成执行阶段后，如果允许中断，则进入中断阶段![11](../assets/OS_b_images/./11.png)

12. 中断装置：发现并相应中断/异常的装置。

13. 中断处理过程![12](../assets/OS_b_images/./12.png)

    1. 发现中断源，提出中断请求（选择响应哪一个程序）
       1. 发现中断寄存器中记录的中断
       2. 决定这些中断是否被屏蔽
       3. 当有多个要响应的中断源时，根据规定的优先级选择一个
    2. 中断当前程序的执行（保护现场）：保存当前程序的 PSW/PC 到核心栈
    3. 转向操作系统的中断处理程序：处理器状态已从用户态转换至内核态。
    4. 恢复现场：恢复原运行程序的 PSW，重新返回中断点，以便执行后续指令。

14. 多中断

    1. 中断屏蔽：当计算机检测到中断时，中断装置通过中断屏蔽决定是否响应已发生的中断。
    2. 中断优先级：多个中断发生时中断装置响应中断的顺序，不同操作系统有不同的中断优先级（PC做出关机操作/重启操作一般是最高级的中断）。
    3. 中断的嵌套处理：当计算机处理中断的过程中可能再响应其他中断，嵌套可能会改变中断的处理次序（先响应的后处理），但是考虑到系统效率和实现代价，嵌套一般限制在3层以内。

15. 多中断处理

    1. 顺序处理（串行处理）：X、Y两个中断同时发生，先响应X、屏蔽Y，待X处理完成后再响应Y。<img src="../assets/OS_b_images/./2-2.png" alt="2-2" style="zoom:25%;" />
    2. 嵌套处理：X、Y 两个中断同时发生，根据中断有限级，先响应中断 X，因为没有屏蔽 Y，则响应并处理 Y，处理 Y 完成后，再处理 X。![3](../assets/OS_b_images/./3.png)
    3. 即时处理：在运行中断处理程序时，如果出现程序性中断事件，在一般情况下，表明此时中断程序有异常，应对其立即响应并处理。

### （7）系统调用

1. 什么是系统调用
   1. *操作系统的程序接口由一组系统调用组成*，系统调用就是由操作系统提供给应用程序/程序员/编程者使用的接口，操作系统所实现的完成某种特定功能的过程。可以理解成一种可供应用程序调用的特殊函数，应用程序可以发出系统调用请求来获得操作系统的服务。<img src="../assets/OS_b_images/./24.png" alt="24" style="zoom:25%;" />
   2. 应用程序通过系统调用请求OS的服务，系统中的各种共享资源都有OS统一掌管。<img src="../assets/OS_b_images/./截屏2022-09-08 下午6.01.24.png" alt="/./截屏2022-09-08 下午6.01.24.png" style="zoom:25%;" />

2. 目的：对上层如果暴露过于细粒度的操作违背了软件复用的原则，所以将一系列的操作封装起来当作系统调用暴露。

2. 系统调用和库函数的区别
   1. OS提供系统调用函数，应用程序调用高级计算机语言的库函数，而高级计算机语言的库函数包装了系统调用函数<img src="../assets/OS_b_images/./截屏2022-09-08 下午6.05.50.png" alt="/./截屏2022-09-08 下午6.05.50.png" style="zoom:25%;" />

4. 系统调用的过程

   1. 有硬件和操作系统合作完成：中断有硬件完成、查入口地址和调用由操作系统完成。
   2.  <img src="../assets/OS_b_images/./截屏2022-09-08 下午6.23.34.png" alt="/./截屏2022-09-08 下午6.23.34.png" style="zoom:25%;" />

5. **凡是与资源相关的操作、会直接影响到其他进程的操作，一定需要操作系统介入，需要通过系统调用实现**。

6. 实现机制

   1. 陷入处理机制：计算机系统中控制和实现系统调用的机制
   2. 陷入指令：也称**访管指令**，或**异常中断指令**，计算机系统为实现系统调用而引起处理器中断的指令
   3. 每个系统调用都事先规定了**编号**，并在**约定**寄存器中规定了传递给内部处理程序的参数
   4. 参数传递方法
      1. 访管指令或自陷指令自带参数，参数放置在指令后的若干单元，叫直接参数
      2. 指令后放置参数的地址，叫间接指令
      3. 通过 CPU 的通用寄存器传递参数，不适用于大量参数传递
      4. 在内存中开辟专门堆栈区传递参数
   5. 操作系统实现系统调用的机制被称为陷阱或异常处理机制。
   6. 由系统调用引起处理器中断的机器指令称为访管指令、自陷指令或中断指令，其中访管指令为非特权指令。

7. 实现的要点：

   1. 编写系统调用处理程序。
   2. 设计一张**系统调用入口地址表**，每个入口地址指向一个系统调用的处理程序，并包含系统调用自带参数的个数。
   3. 陷入处理机制需开辟现场保护区，以保存发生系统调用时的处理器现场。

8. 和函数调用的区别：

   |                | 系统调用                                 | 函数调用                                   |
   | -------------- | ---------------------------------------- | ------------------------------------------ |
   | 调用形式       | 按地址转向                               | 功能号调用                                 |
   | 实现方式       | 用户态转换内核态，在内核态执行访问核心栈 | 用户态                                     |
   | 被调用代码位置 | 动态调用，服务例程位于操作系统内         | 静态调用，调用程序和被调用程序在同一程序内 |
   | 提供方式       | 由操作系统提供                           | 编程语言提供                               |
